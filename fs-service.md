# 文件服务v2需求说明书
-------
[toc]
-------

## 0. 整体流程介绍
文件服务V1版本的接口存在如下问题：
- **文件越权查看**：第一阶段fs返回的FileId，浏览器客户端可以hack。因FileId为数据库自增ID，且应用端对FileID不做检查，通过修改fileId的值，用户可以越权查看他人文件。
- **上传垃圾文件**：获取第一阶段（preUpload）Token后，服务器并不真正检查preUpolad阶段的信息，与实际上传文件是否一致，这导致可能上传信息非法。
- **不支持公开URL**：目前下载链接均为一次一密，对可匿名访问的URL支持不好。
- **URL暴露FILEID**：上传及下载URL均暴露了FileID，因FileID为顺序数据库Id，这会带来潜在不安全因素。
- **缺少文件的后续处理操作**：例如图片简单处理（压缩、尺寸修改），文件签名验签等等。

为解决以上问题，新版文件服务设计如下：
- **支持两类Client SDK**：
  - _browser.js sdk_: 浏览器使用的SDK，用于web应用开发。使用此类SDK，文件服务将通过回调应用服务器的方式，确认上传文件正确；确认文件上传信息正确后，再向浏览器返回200。应用在文件服务callback的时候，可以获得上传ID，并记录在数据库；应用服务器不通过Js获取FileId。
  - _java clent sdk_: 服务器端使用的SDK，用于应用服务器向文件服务上传文件。此类SDK支持直接返回上传成功结果，无需回调确认。
- **校验etag信息**: preUpload的时候，计算etag；二阶段上传时，校验etag，如果信息不匹配则返回上传失败，避免上传文件不一致问题。
- **调整上传下载URL**: 上传及下载URL中均隐藏fileId。
- **新增获取公开URL接口**：如获取公开URL，则会生成一个在cdn.chinaclear.cn下面的URL链接，该链接通过CDN托管，并具有防盗链功能。可通过此功能实现头像上传、匿名文件上传等（例如股东大会网络投票、法律法规库等系统，PDF资料为公开信息，如果确认大会召开，则直接生成匿名链接，避免流量全部流向公司带宽）。
- **js客户端支持浏览器端图片压缩**：此功能主要用于支持OCR，人脸识别等项目。图片通过h5 api压缩后，上传到服务器端。公网的fs-nginx，服务器端限制文件上传大小，超过限制需分片上传；内网的gw-nginx，服务器端适当增加文件大小。
- **优化文件同步处理框架**：现有代码已经具备“PDF转图片”、“图片防盗链”等同步处理逻辑，为提升系统可扩展性，可优化相关代码，整理为pipeline框架（TODO：如何与OCR，人脸识别结合有待考虑)


## 1. 客户端
### 1.1 browser.js SDK

### 1.2 java Client SDK

### 1.3 小程序 client SDK 

## 2. 服务器端（Java Server SDK）
### 2.1 第一阶段上传（生成客户端上传凭证）
客户端（移动端或者Web端）上传文件的时候，需要从客户自己的业务服务器获取上传凭证，而这些上传凭证是通过服务端的SDK来生成的，然后通过客户自己的业务API分发给客户端使用。

### 2.2 第二阶段上传

### 2.3 文件下载URL生成
- 公共URL
- 隐私URL

### 2.4 文件删除